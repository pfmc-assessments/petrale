\clearpage
# Figures
```{r, read-csv, results = "asis"}
plot_info = read.csv(file.path(mod_loc_relative, "plots", "plotinfotable_for_doc.csv"))
```

\clearpage
<!-- don't allow section headers to float relative to figure locations -->
<!-- \floatplacement{figure}{H}  -->

## Data 
<!-- ====================================================================== --> 
<!-- *******************    Assessment Map      *************************** --> 
<!-- ====================================================================== --> 


```{r, data-plot, results = "asis"}
sa4ss::add_figure(
filein = file.path(mod_loc_relative, "plots", "data_plot2.png"), 
caption = 
  "Data presence by year for each fleet, where circle area is
relative within a data type. Circles are proportional to
total catch for catches; to precision for indices, discards, and
mean body weight observations; and to total sample size for
compositions.",
label = "data-plot"
)
```

<!-- ====================================================================== -->  
<!-- ****************** Catches Used in the Model ************************* --> 
<!-- ====================================================================== -->  

## Catch and estimated discards

```{r, catch-figures-r4ss, results = "asis"}
sa4ss::add_figure(
filein = file.path(mod_loc_relative, "plots", "catch2 landings stacked.png"), 
caption = "Landings (mt) by fleet used in the base model.",
label = "catch-figures-r4ss"
)

sa4ss::add_figure(
filein = file.path(mod_loc_relative, "plots", "catch16 landings + dead discards.png"), 
caption = "Landings plus dead discards (mt) by fleet as estimated in the base model.",
label = "catchdiscard-figures-r4ss"
)

sa4ss::add_figure(
filein = "../figures/Catch comparison graph.png", 
caption = "Comparison of landings used in this assessment (red line) with landings used in 2019 assessment (dashed black line) by state and fleet. Please see section on Historical landings for details.",
label = "catch-comparison"
)

```

<!-- ====================================================================== --> 
<!-- ******************* Data Used in the Model *************************** --> 
<!-- ====================================================================== --> 

```{r, index-figures, results = "asis"}
sa4ss::add_figure(
filein = "../figures/indices/survey_density.png", 
caption = paste("Predicted density from the geostatistical standardization of the",
  "Triennial Survey (left) and the WCGBTS (right) in 2004, the one year in which",
  "both surveys were conducted. Density is on a log scale and the colors correspond",
  "to different scales as shown in the two legends."),
label = "survey-density"
)

sa4ss::add_figure(
filein = "../figures/indices/presence-absence_by_depth.png", 
caption = paste("Presence/absence of petrale sole by depth",
  "in the WCGBTS. Bar widths are proportional to the number of hauls in that bin.",
  "Values are aggregated across all years of the survey."),
label = "presence-absence-by-depth"
)

sa4ss::add_figure(
filein = "../figures/indices/presence-absence_by_latitude.png", 
caption = paste("Presence/absence of petrale sole by latitude",
  "in the WCGBTS. Bar widths are proportional to the number of hauls in that bin.",
  "Values are aggregated across all years of the survey."),
label = "presence-absence-by-latitude"
)

sa4ss::add_figure(
filein = "../figures/indices/index_Tri.png", 
caption = paste("Estimated index from the geostatistical standardization of the",
  "Triennial Survey including estimated biomass in each state."),
label = "survey-tri"
)

sa4ss::add_figure(
filein = "../figures/indices/index_WCGBTS.png", 
caption = paste("Estimated index from the geostatistical standardization of the",
  "WCGBTS including estimated biomass in each state."),
label = "survey-wcgbts"
)

```

## Biology


## Model Results

### Bridging


### Model Structure

\clearpage

### Estimated Biology
```{r, results = 'asis'}
sa4ss::add_figure(
filein = file.path(mod_loc_relative, "plots", "bio1_sizeatage.png"),
caption = "Model estimated length-at-age in the beginning of the year. Shaded area indicates 95 percent distribution of length-at-age around the estimated growth curve",
label = 'mod-est-len-age')

sa4ss::add_figure(
filein = file.path(mod_loc_relative, "plots", "bio3_sizeatage_plus_WT_and_MAT.png"),
caption = "Relationship between growth, maturity, and weight. Length at age is in the top-left panel with weight (thick lines) and maturity (thin lines) shown in top-right and lower-left panels",
label = 'mod-est-len-age2')

sa4ss::add_figure(
filein = file.path("../figures/Petrale_fxn_ogive.png"),
caption = "Maturity ogive showing fit to observed fraction mature within each length bin.",
label = 'maturity')
```


### Selectivity
```{r, results = 'asis'}
sa4ss::add_figure(
filein = file.path(mod_loc_relative, "plots",  "sel01_multiple_fleets_length1.png"), 
caption = paste("Ending-year selectivity at length for multiple fleets.",
  "Solid lines are female selectivity, dashed are male."),
label = 'sel_length')

sa4ss::add_figure(
filein = file.path(mod_loc_relative, "plots",  "sel02_multiple_fleets_age2.png"), 
caption = paste("Ending-year selectivity at age derived from selectivity at length",
  "(solid female, dashed male)."),
label = 'sel-age')

sa4ss::add_figure(
filein = file.path(mod_loc_relative, "custom_plots", "selectivity_time-varying_fem.png"), 
caption = paste("Time-varying female selectivity (top) and retention (bottom)",
  "for the fishing fleets. Retention is the same for females and males.",
  "Note: the legend shows the "),
label = 'sel-tv-fem')
sa4ss::add_figure(
filein = file.path(mod_loc_relative, "custom_plots",  "selectivity_time-varying_mal.png"), 
caption = paste("Time-varying male selectivity (top) and retention (bottom)",
  "for the fishing fleets. Retention is the same for females and males."),
label = 'sel-tv-mal')

```


### Recruitment

```{r, results = 'asis'}
sa4ss::add_figure(
filein = file.path(mod_loc_relative, "plots",  "recdevs2_withbars.png"), 
caption = paste("Recruitment deviations with 95% intervals.",
  "Black points and lines represent the 'main' period while the blue",
  "points and lines are the early and late periods."),
label = 'recdevs')

sa4ss::add_figure(
filein = file.path(mod_loc_relative, "custom_plots",  "recruit_fit_bias_adjust.png"), 
caption = paste0("Bias adjustment applied to the recruitment deviations (red line). ",
  "Points are transformed variances relative to $\\sigma_R = ", mod_base$sigma_R_in, "$."),
label = 'biasadj')
```
\clearpage


### Fits to Data

\clearpage

#### Fits to indices

```{r, results = 'asis'}
sa4ss::add_figure(
filein = file.path(mod_loc_relative, "plots",  "index2_cpuefit_WCGBTS.png"), 
caption = paste("Fit to index data for WCGBTS. Lines indicate 95% uncertainty",
  "interval around index values based on the model assumption of lognormal error."),
label = 'index-wcgbts-fit')

sa4ss::add_figure(
filein = file.path(mod_loc_relative, "plots",  "index2_cpuefit_Triennial.png"), 
caption = paste("Fit to index data for the Triennial survey. Lines indicate 95% uncertainty",
  "interval around index values based on the model assumption of lognormal error.",
  "Thicker lines indicate input uncertainty before addition of",
  "estimated additional uncertainty parameter."),
label = 'index-tri-fit')
```

\clearpage

#### Fits to Length and Age Compositions
<!-- TODO: add Francis plots -->
```{r, results = 'asis'}
sa4ss::add_figure(
filein = file.path(mod_loc_relative, "plots",  "comp_lenfit__aggregated_across_time.png"), 
caption = paste("Length composition aggregated across years by fleet with the",
  "model estimated fit to the data by sex (red female and blue male)."),
label = 'len-agg-fit')

sa4ss::add_figure(
filein = file.path(mod_loc_relative, "plots",  "comp_lendat__multi-fleet_comparison.png"), 
caption = paste("Length composition data for all fleets",
  "(red female, blue male, grey unsexed)."),
label = 'len-all-bubbles')

sa4ss::add_figure(
filein = file.path(mod_loc_relative, "plots",  "comp_lenfit__multi-fleet_comparison.png"), 
caption = paste("Pearson residuals for fit to length composition data for all fleets",
  "(red female, blue male, grey unsexed).",
  "Closed bubbles are positive residuals (observed > expected) and open bubbles",
  "are negative residuals (observed < expected)."),
label = 'len-all-pearson')

sa4ss::add_figure(
filein = file.path(mod_loc_relative, "plots",  "comp_lenfit_data_weighting_TA1.8_North.png"), 
caption = paste("Mean lengths calculated from the observed (black) and expected (blue) length compositions from the North fleet. Retained catch is shown in the top and discards on the bottom. 95% intervals for the observations are based on the adjusted input sample sizes."),
label = 'len-francis-north')

sa4ss::add_figure(
filein = file.path(mod_loc_relative, "plots",  "comp_lenfit_data_weighting_TA1.8_South.png"), 
caption = paste("Mean lengths calculated from the observed (black) and expected (blue) length compositions from the South fleet. Retained catch is shown in the top and discards on the bottom. 95% intervals for the observations are based on the adjusted input sample sizes."),
label = 'len-francis-south')

sa4ss::add_figure(
filein = file.path(mod_loc_relative, "plots",  "comp_lenfit_data_weighting_TA1.8_Triennial.png"), 
caption = paste("Mean lengths calculated from the observed (black) and expected (blue) length compositions from the Triennial Survey. 95% intervals for the observations are based on the adjusted input sample sizes."),
label = 'len-francis-tri')

sa4ss::add_figure(
filein = file.path(mod_loc_relative, "plots",  "comp_lenfit_data_weighting_TA1.8_WCGBTS.png"), 
caption = paste("Mean lengths calculated from the observed (black) and expected (blue) length compositions from the WCGBTS. 95% intervals for the observations are based on the adjusted input sample sizes."),
label = 'len-francis-wcgbts')

sa4ss::add_figure(
filein = file.path(mod_loc_relative, "plots", "comp_agefit__aggregated_across_time.png"), 
caption = "Age composition data aggregated across time by fleet and sex (red female and blue male).",
label = 'agg-marg-age-fit')

sa4ss::add_figure(
filein = file.path(mod_loc_relative, "plots",  "comp_agedat__multi-fleet_comparison.png"), 
caption = paste("Age composition data for all fleets",
  "(red female, blue male)."),
label = 'age-all-bubbles')

sa4ss::add_figure(
filein = file.path(mod_loc_relative, "plots",  "comp_agefit__multi-fleet_comparison.png"), 
caption = paste("Pearson residuals for fit to age composition data for all fleets",
  "(red female, blue male).",
  "Closed bubbles are positive residuals (observed > expected) and open bubbles",
  "are negative residuals (observed < expected)."),
label = 'age-all-pearson')

sa4ss::add_figure(
filein = file.path(mod_loc_relative, "plots", "comp_condAALdat_bubflt4mkt0_page1.png"), 
caption = paste("Conditional age-at-length data from WCGBTS",
  "(data plot 1 of 2, interleaved with the residual plots to facilitate flipping back and forth)."),
label = 'caal-dat1')

sa4ss::add_figure(
filein = file.path(mod_loc_relative, "plots", "comp_condAALfit_residsflt4mkt0_page1.png"), 
caption = paste("Pearson residuals for conditional age-at-length data from WCGBTS",
  "(residual plot 1 of 2, interleaved with the data plots to facilitate flipping back and forth)."),
label = 'caal-fit1')

sa4ss::add_figure(
filein = file.path(mod_loc_relative, "plots", "comp_condAALdat_bubflt4mkt0_page2.png"), 
caption = paste("Conditional age-at-length data from WCGBTS",
  "(data plot 2 of 2, interleaved with the residual plots to facilitate flipping back and forth)."),
label = 'caal-dat2')

sa4ss::add_figure(
filein = file.path(mod_loc_relative, "plots", "comp_condAALfit_residsflt4mkt0_page2.png"), 
caption = paste("Pearson residuals for conditional age-at-length data from WCGBTS",
  "(residual plot 2 of 2, interleaved with the data plots to facilitate flipping back and forth)."),
label = 'caal-fit2')

```

\clearpage

#### Fits to discard fractions and mean weight observations

```{r, results = 'asis'}
sa4ss::add_figure(
filein = file.path(mod_loc_relative, "plots",  "discard_fitNorth.png"), 
caption = paste("Discard fraction for the North fishery with 95% intervals (black) with fit of expected value (blue)."),
label = 'discard_fitNorth')

sa4ss::add_figure(
filein = file.path(mod_loc_relative, "plots",  "discard_fitSouth.png"), 
caption = paste("Discard fraction for the South fishery with 95% intervals (black) with fit of expected value (blue)."),
label = 'discard_fitSouth')

sa4ss::add_figure(
filein = file.path(mod_loc_relative, "plots",  "bodywt_fit_fltNorth.png"), 
caption = paste("Mean individual body weight of the discards for the North fishery with 95% intervals (black) with fit of expected value (blue)."),
label = 'mnwt_fitNorth')

sa4ss::add_figure(
filein = file.path(mod_loc_relative, "plots",  "bodywt_fit_fltSouth.png"), 
caption = paste("Mean individual body weight of the discards for the South fishery with 95% intervals (black) with fit of expected value (blue)."),
label = 'mnwt_fitSouth')

```

\clearpage

### Time-series

<!-- ======================================================= -->  
<!-- ****************** Time Series ************************ --> 
<!-- ======================================================= -->
```{r, results = 'asis'}
sa4ss::add_figure(
filein = file.path("../figures/historical_assessment_timeseries.png"), 
caption = paste("Comparison of biomass time series (colored lines) across recent assessments.",
  "Units are estimated biomass of females and males ages 3 and older.",
  "Total mortality from the base model (black bars) is included as well.",
  "Spawning biomass is not comparable across these assessments because the inclusion",
  "of a fecundity relationship starting in 2023 which results in spawning output in units of eggs."),
label = 'smry-bio-historical')


```{r, results = 'asis'}
sa4ss::add_figure(
filein = file.path(mod_loc_relative, "plots", "ts7_Spawning_output_with_95_asymptotic_intervals_intervals.png"), 
caption = "Estimated time series of female spawning output (in trillions of eggs) with approximate 95% asymptotic intervals.",
label = 'ssb')

sa4ss::add_figure(
filein = file.path(mod_loc_relative, "plots", "ts9_Relative_spawning_output_intervals.png"), 
caption = "Estimated time series of relative spawning output with approximate 95% asymptotic intervals.",
label = 'depl')


sa4ss::add_figure(
filein = file.path(mod_loc_relative, "plots", "SPR3_ratiointerval.png"), 
caption = "Estimated time series of the relative fishing intensity with approximate 95% asymptotic intervals.",
label = 'spr')

info <- plot_info %>% dplyr::filter(grepl("SPR4_phase", label))
sa4ss::add_figure(
filein = file.path(mod_loc_relative, "plots", "SPR4_phase.png"), 
caption = info$caption,
label = 'phase')

add_figure(
filein = file.path(mod_loc_relative, "plots", "yield2_yield_curve_with_refpoints.png"), 
caption = "Equilibrium yield curve for the base case model. Values are based on the most recent
fishery selectivities and retention curves and with steepness fixed at 0.80.",
label = 'es-yield')
```

```



\clearpage

### Sensitivity Analyses and Retrospectives
```{r, results = 'asis'}
sa4ss::add_figure(
filein = file.path(mod_loc_relative, "custom_plots", "sens_timeseries_index1.png"), 
label = 'sens-index1',
caption = paste("Time series of spawning biomass (top) and fraction of unfished",
            "(bottom) for the sensitivity analyses related to",
            "index data."))
```

```{r, results = 'asis'}
sa4ss::add_figure(
filein = file.path(mod_loc_relative, "custom_plots", "sens_timeseries_comp1.png"), 
label = 'sens-comp1',
caption = paste("Time series of spawning biomass (top) and fraction of unfished",
            "(bottom) for the sensitivity analyses related to",
            "composition data."))

sa4ss::add_figure(
filein = file.path(mod_loc_relative, "custom_plots", "sens_timeseries_comp2.png"), 
label = 'sens-comp2',
caption = paste("Time series of recruitment (top) and recruitment deviations",
            "(bottom) for the sensitivity analyses related to",
            "composition data."))

sa4ss::add_figure(
filein = file.path(mod_loc_relative, "custom_plots", "sens_timeseries_bio1.png"), 
label = 'sens-bio1',
caption = paste("Time series of spawning biomass (top) and fraction of unfished",
            "(bottom) for the sensitivity analyses related to",
            "biology."))

# recruitment sensitivities
sa4ss::add_figure(
filein = file.path(mod_loc_relative, "custom_plots", "sens_timeseries_recruit1.png"), 
label = 'sens-recruit1',
caption = paste("Time series of spawning biomass (top) and fraction of unfished",
            "(bottom) for the sensitivity analyses related to",
            "recruitment."))

sa4ss::add_figure(
filein = file.path(mod_loc_relative, "custom_plots", "sens_timeseries_recruit2.png"), 
label = 'sens-recruit2',
caption = paste("Time series of recruitment (top) and recruitment deviations",
            "(bottom) for the sensitivity analyses related to",
            "recruitment."))

# Canada sensitivities
sa4ss::add_figure(
  filein = "../models/2023.a034.703/plots/index9_standcpueall.png",
  label = 'sens-Canada0',
  caption = "Standardized indices showing comparison of the WCGBTS and Canadian indices as well as the Triennial index."
)

sa4ss::add_figure(
filein = file.path(mod_loc_relative, "custom_plots", "sens_timeseries_Canada1.png"), 
label = 'sens-Canada1',
caption = paste("Time series of spawning biomass (top) and fraction of unfished",
            "(bottom) for the sensitivity analyses related to",
            "data from Canada."))

```

```{r, results = 'asis'}
# define path to retro and profile figs
figures_diags <- "../figures/diags_model34/"
```

```{r, results = 'asis'}
add_figure(
filein = file.path(figures_diags, "retro_compare2_spawnbio_uncertainty.png"), 
caption = "Change in the estimate of spawning output when the most recent 5 years of data area removed sequentially",
label = 'retro-ssb')
```

\clearpage

```{r, results = 'asis'}
add_figure(
filein = file.path(figures_diags, "retro_compare13_indices_flt4.png"), 
caption = "Change in the fit to the WCGBTS index when the most recent 5 years of data area removed sequentially",
label = 'retro-index')
```

\clearpage

```{r, results = 'asis'}
add_figure(
filein = file.path(figures_diags, "retro_compare4_Bratio_uncertainty.png"),
caption = "Change in the estimate of fraction unfished when the most recent 5 years of data area removed sequentially",
label = 'retro-depl')
```

\clearpage

### Likelihood Profiles

```{r, results = 'asis'}
add_figure(
filein = file.path(figures_diags, "piner_panel_SR_LN(R0).png"), 
caption = "Change in the negative log-likelihood across a range of log(R~0~) values",
label = 'r0-profile')
```

```{r, results = 'asis'}
add_figure(
filein = file.path(figures_diags, "parameter_panel_SR_LN(R0).png"), 
caption = paste("Change in quantities of interest related to spawning output",
  "across a range of log(R~0~) values:",
  "Fraction of unfished spawning output in 2023 (top-right),",
  "Spawning output in 2023 (bottom-right), and ",
  "Unfished equilibrium spawning output (bottom-left).",
  "These are shown along with the change in total negative log-likelihood",
  "(top-left, matches previous figure)."),
label = 'r0-profile-pars')
```


\pagebreak

```{r, results = 'asis'}
add_figure(
filein = file.path(figures_diags, "piner_panel_SR_BH_steep.png"), 
caption = "Change in the negative log-likelihood across a range of steepness (h) values",
label = 'h-profile')
```
```{r, results = 'asis'}
add_figure(
filein = file.path(figures_diags, "parameter_panel_SR_BH_steep.png"), 
caption = paste("Change in quantities of interest related to spawning output",
  "across a range of steepness (h) values:",
  "Fraction of unfished spawning output in 2023 (top-right),",
  "Spawning output in 2023 (bottom-right), and ",
  "Unfished equilibrium spawning output (bottom-left).",
  "These are shown along with the change in total negative log-likelihood",
  "(top-left, matches previous figure)."),
label = 'h-profile-pars')
```

```{r, results = 'asis'}
add_figure(
filein = file.path(figures_diags, "piner_panel_NatM_uniform_Fem_GP_1.png"), 
caption = "Change in the negative log-likelihood across a range of female natural mortality (M) values",
label = 'm-profile')
```

```{r, results = 'asis'}
add_figure(
filein = file.path(figures_diags, "parameter_panel_NatM_uniform_Fem_GP_1.png"), 
caption = paste("Change in quantities of interest related to spawning output",
  "across a range of female natural mortality (M) values:",
  "Fraction of unfished spawning output in 2023 (top-right),",
  "Spawning output in 2023 (bottom-right), and ",
  "Unfished equilibrium spawning output (bottom-left).",
  "These are shown along with the change in total negative log-likelihood",
  "(top-left, matches previous figure)."),
label = 'm-profile-pars')
```


### Reference Points and Forecasts