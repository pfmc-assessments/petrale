---
title: "Catch only projection for petrale sole"
author: "Ian G. Taylor" 
affiliation: 'NOAA Fisheries Northwest Fisheries Science Center, 2725 Montlake Blvd E, Seattle, WA 98112'
date: today
format: 
  pdf:
    template: catch_only_projection_template.tex
params:
  species: "petrale sole"
  assess_year: 2023
  current_year: 2025
  final_proj_year: 2036
  category: 1
  sigma: 0.50
  p_star: 0.45
  spawn_output_decimals: 2
---


```{r}
#| label: parameters
#| echo: false
#| warning: false
#| message: false
species <- params$species
Species <- stringr::str_to_sentence(params$species)
assess_year <- params$assess_year
current_year <- params$current_year
final_proj_year <- params$final_proj_year
category <- params$category
sigma <- params$sigma
p_star <- params$p_star
spawn_output_decimals <- params$spawn_output_decimals

# original model
model_original <- r4ss::SS_output(
    dir = "../models/2023.a034.011_forecast_SR", # directory is relative to quarto file
    verbose = FALSE,
    printstats = FALSE,
    hidewarn = TRUE
)

# catch-only projection
model <- r4ss::SS_output(
    dir = "standard",
    verbose = FALSE,
    printstats = FALSE,
    hidewarn = TRUE
)

```

This document details a catch-only projection for `r species`. The most recent assessment for `r species` was conducted in `r assess_year`. This analysis updates catches between `r assess_year` - `r current_year` to the removals by year from the Groundfish Multiyear Mortality (GEMM) report. The removals for `r current_year` and `r current_year + 1` were set equal to mortality projections provided by the Groundfish Management Team (GMT) for each fleet in the model. For years `r current_year + 2` and beyond, removals were set equal to the projected Annual Catch Limit (ACL) based on a category `r category` time-varying $\sigma$ of `r sigma` and a P* value of `r p_star`. These buffers are the same as in the previous stock assessment, with two additional years of buffers for years `r current_year + 10` and `r current_year + 11`. 

```{r}
#| label: tbl-proj
#| echo: false
#| warning: false
#| message: false
#| tbl-cap: "Projected OFLs (mt), ABCs (mt), ACLs (mt), buffer, spawning output, and stock status given the assumed removals."

# define ranges of years to get values
all_years <- assess_year:final_proj_year
old_proj_years <- all_years[-(1:2)] # remove first two years of old projection
proj_years <- (current_year + 2):final_proj_year
catch_years <- assess_year:(current_year + 1)

# get realized catch from model output
catch <- model$derived_quants |>
    dplyr::filter(Label %in% paste0("ForeCatch_", catch_years)) |>
    dplyr::summarise(
        Year = stringr::str_extract(Label, "\\d+"),
        Catch = Value
    )
ofl_original <- model_original$derived_quants |>
    dplyr::filter(Label %in% paste0("OFLCatch_", old_proj_years)) |>
    dplyr::summarise(
        Year = stringr::str_extract(Label, "\\d+"),
        OFL_original = Value
    )
ofl <- model$derived_quants |>
    dplyr::filter(Label %in% paste0("OFLCatch_", proj_years)) |>
    dplyr::summarise(
        Year = stringr::str_extract(Label, "\\d+"),
        OFL = Value
    )
acl <- model$derived_quants |>
    dplyr::filter(Label %in% paste0("ForeCatch_", proj_years)) |>
    dplyr::summarise(
        Year = stringr::str_extract(Label, "\\d+"),
        ACL = Value
    )
acl_original <- model_original$derived_quants |>
    dplyr::filter(Label %in% paste0("ForeCatch_", old_proj_years)) |>
    dplyr::summarise(
        Year = stringr::str_extract(Label, "\\d+"),
        ACL_original = Value
    )
sb <- model$derived_quants |>
    dplyr::filter(Label %in% paste0("SSB_", all_years)) |>
    dplyr::summarise(
        Year = stringr::str_extract(Label, "\\d+"),
        SB = Value
    )
status_original <- model_original$derived_quants |>
    dplyr::filter(Label %in% paste0("Bratio_", all_years)) |>
    dplyr::summarise(
        Year = stringr::str_extract(Label, "\\d+"),
        status_original = round(Value, 3)
    )
status <- model$derived_quants |>
    dplyr::filter(Label %in% paste0("Bratio_", all_years)) |>
    dplyr::summarise(
        Year = stringr::str_extract(Label, "\\d+"),
        status = round(Value, 3)
    )
# combine all the tables above (joined by year)
purrr::reduce(
    list(ofl_original, ofl, acl_original, acl, sb, status_original, status, catch),
    dplyr::full_join
) |>
    dplyr::arrange(Year) |>
    dplyr::relocate(Catch, .after = Year) |>
    dplyr::mutate(
        Buffer = dplyr::case_when(
            status >= model$btarg ~ round(ACL / OFL, 3),

            .default = NA
        ),
        .after = ACL
    ) |>
    dplyr::rename(
        `Assumed Removals (mt)` = Catch,
        `Stock Status` = status,
        `Stock Status_original` = status_original,
        `Spawning Output` = SB,
    ) |>
    dplyr::rename_with(
        ~ gsub("_original", paste0(" (", assess_year, " model)"), .x)
    ) |>
    gt::gt() |>
    gt::fmt_number(
        columns = c(2:6),
        decimals = 0
    ) |>
    gt::fmt_number(
        columns = 8,
        decimals = spawn_output_decimals
    ) |>
    gt::tab_options(
        table.font.size = 11, # reduced font size
        latex.use_longtable = TRUE
    ) |>
    gt::sub_missing(
        columns = tidyselect::everything(),
        missing_text = "---"
    ) |>
    gt::cols_align(
        align = "center"
    ) |>
    gt::cols_width(
        everything() ~ px(65)
    ) |>
    gt::as_latex()


```



